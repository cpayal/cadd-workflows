# DiffDock Virtual Screening Workflow

This repository contains a minimal reproducible workflow for **AI-based molecular docking** using **DiffDock**.  
It demonstrates protein preparation, ligand conversion, DiffDock inference, and post-docking analysis using an example target (**CDK2**, PDB ID: *1H1Q*).

---

## Repository Structure

```
1_prep_pdbqt2pdb.sh                # Converts AutoDock-prepared receptor (PDBQT) to protonated PDB
2_prep_ligands.sh                  # Converts ligands from PDBQT to SDF and prepares DiffDock input CSV
3_run_diffdock.sh                  # Wrapper script to launch DiffDock inference
4_diffdock-summary-analysis.ipynb  # Notebook for post-docking pose and hit analysis
run_diffdock.sh                    # Alternate launcher for DiffDock CLI
1H1Q.pdb                           # Raw protein structure (CDK2)
1H1Q_receptorH.pdbqt               # Receptor prepared with Meeko for AutoDock
1H1Q_receptorH.pdb                 # Protonated receptor used for DiffDock
pdbqt_scrubbed/                    # Directory containing ligand PDBQT inputs
data/                              # Directory for CSVs, ligand SDFs, and DiffDock results
environment.yml                    # Conda environment for reproducibility
```

---

## Environment Setup

Create and activate the conda environment:

```bash
conda env create -f environment.yml
conda activate diffdock_env
```

**Environment includes:**
- Python ≥ 3.9  
- PyTorch + CUDA (for DiffDock inference)  
- RDKit for molecular structure handling  
- Open Babel for format conversion  
- torch_geometric, biopython, pandas, tqdm, numpy  

---

## Workflow Overview

| Step | Script / Notebook | Description |
|------|-------------------|-------------|
| 1 | `1_prep_pdbqt2pdb.sh` | Converts AutoDock receptor (PDBQT) to protonated PDB for DiffDock. Retains HIS protonation and metal centers. |
| 2 | `2_prep_ligands.sh` | Converts ligands from `.pdbqt` to `.sdf`, adds hydrogens, and generates `screen.csv` for DiffDock input. |
| 3 | `3_run_diffdock.sh` | Runs DiffDock inference using the generated CSV, outputs predicted complexes and confidence scores. |
| 4 | `4_diffdock-summary-analysis.ipynb` | Summarizes predicted poses, compares with reference ligand (RMSD), clusters hits, and ranks compounds. |

---

## Example Run

### Step 1: Prepare receptor
```bash
bash 1_prep_pdbqt2pdb.sh 1H1Q_receptorH.pdbqt
```
Creates a protonated receptor file:
```
1H1Q_receptorH.pdb
```

---

### Step 2: Prepare ligands
```bash
bash 2_prep_ligands.sh pdbqt_scrubbed 1H1Q_receptorH.pdb data
```
This script:
- Converts all `.pdbqt` ligands in `pdbqt_scrubbed/` to `.sdf`
- Writes them to `data/ligands_sdf/`
- Generates the DiffDock input file `data/screen.csv` with columns:  
  `complex_name,protein_path,ligand_description,protein_sequence,pocket_center_x,pocket_center_y,pocket_center_z,pocket_radius`

---

### Step 3: Run DiffDock
```bash
python -m inference   --config default_inference_args.yaml   --protein_ligand_csv data/screen.csv   --out_dir data/diffdock_results   --samples_per_complex 10
```

Outputs:
- Docked complexes (`.pdb`)
- Predicted confidence scores
- Logs under `data/diffdock_results/`

---

### Step 4: Analyze Results
Open the Jupyter notebook:
```
4_diffdock-summary-analysis.ipynb
```

The notebook performs:
- Pose clustering and RMSD comparison to co-crystal reference  
- Ranking by confidence and geometric convergence  
- Visualization of representative hits and their chemical diversity  
- Selection of top compounds for follow-up  

---

## Output Summary

- **Predicted complexes:** Docked poses generated by DiffDock  
- **Confidence scores:** Per-complex likelihood of correct binding orientation  
- **screen.csv:** Input ligand–protein combinations  
- **diffdock_results/:** All generated poses and metadata  
- **Analysis notebook:** Clustered and ranked results with 3D visualizations  

---

## Notes

- Target: **CDK2 (1H1Q)**, Cyclin A–CDK2 complex  
- Protonation handled via **Meeko**, preserved through conversion  
- Ligands: Subset of **Enamine Hinge Binder Library**  
- Pocket center: *(6.234, 44.214, 50.819)*, radius *10 Å*, defined around the co-crystal ligand site  
- Workflow outputs can be directly compared with classical AutoDock results for performance benchmarking  

---

## Citation

If you use this workflow, please cite:  
- Corso et al., *DiffDock: Diffusion steps, twists, and turns for molecular docking*, NeurIPS (2022).  
- O’Boyle et al., *Open Babel: An open chemical toolbox*, *J. Cheminf.* (2011).  
- Trott & Olson, *AutoDock Vina: Improving the speed and accuracy of docking*, *J. Comput. Chem.* (2010).

---

## Optional .gitignore

Add this before pushing to GitHub to avoid large files:

```
__pycache__/
*.log
*.out
*.chk
*.pt
data/diffdock_results/
data/ligands_sdf/
pdbqt_scrubbed/
```
